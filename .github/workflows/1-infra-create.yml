name: Asterra Infra and Deploy

on:
  push:
    branches:
      - main

      
env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: asterra-app
  EKS_CLUSTER_NAME: asterra-cluster

jobs:
  terraform-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
          terraform_wrapper: false

      - name: Terraform Init & Apply
        id: tf
        working-directory: ./terraform
        run: |
          terraform init
          terraform apply -auto-approve
          
          # Export outputs to environment
          echo "DB_HOST=$(terraform output -raw rds_hostname)" >> $GITHUB_ENV
          echo "S3_BUCKET=$(terraform output -raw s3_bucket_name)" >> $GITHUB_ENV
          echo "APP_ROLE_ARN=$(terraform output -raw iam_role_arn)" >> $GITHUB_ENV
          echo "ECR_URL=$(terraform output -raw ecr_repository_url)" >> $GITHUB_ENV
          
          # Also capture for logging (without exposing sensitive data)
          echo "âœ… Infrastructure provisioned successfully"
          echo "ğŸ“¦ S3 Bucket: $(terraform output -raw s3_bucket_name)"

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push Docker Image
        run: |
          # Use commit SHA for better traceability
          IMAGE_TAG="${GITHUB_SHA::8}"
          
          echo "ğŸ‹ Building Docker image..."
          docker build -t ${{ env.ECR_URL }}:${IMAGE_TAG} \
                       -t ${{ env.ECR_URL }}:latest .
          
          echo "â¬†ï¸  Pushing to ECR..."
          docker push ${{ env.ECR_URL }}:${IMAGE_TAG}
          docker push ${{ env.ECR_URL }}:latest
          
          # Save image tag for deployment
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'

      - name: Configure kubectl for EKS
        run: |
          echo "ğŸ”§ Configuring kubectl for EKS cluster..."
          aws eks update-kubeconfig \
            --name ${{ env.EKS_CLUSTER_NAME }} \
            --region ${{ env.AWS_REGION }}
          
          # Verify connection
          kubectl cluster-info
          kubectl get nodes

      - name: Create Kubernetes Secrets
        run: |
          echo "ğŸ” Creating/updating Kubernetes secrets..."
          
          # Create database secret
          kubectl create secret generic db-secret \
            --from-literal=password='${{ secrets.DB_PASSWORD }}' \
            --dry-run=client -o yaml | kubectl apply -f -
          
          echo "âœ… Secrets configured"

      - name: Validate Helm Chart
        run: |
          echo "ğŸ” Validating Helm chart..."
          helm lint ./helm
          
          echo "ğŸ“‹ Dry-run deployment..."
          helm upgrade --install asterra-app ./helm \
            --set image.repository=${{ env.ECR_URL }} \
            --set image.tag=${{ env.IMAGE_TAG }} \
            --set env.databaseUrl="${{ env.DB_HOST }}" \
            --set env.s3Bucket="${{ env.S3_BUCKET }}" \
            --set iam.roleArn="${{ env.APP_ROLE_ARN }}" \
            --dry-run --debug

      - name: Deploy to EKS with Helm
        run: |
          echo "ğŸš€ Deploying application to EKS..."
          
          helm upgrade --install asterra-app ./helm \
            --set image.repository=${{ env.ECR_URL }} \
            --set image.tag=${{ env.IMAGE_TAG }} \
            --set env.databaseUrl="${{ env.DB_HOST }}" \
            --set env.s3Bucket="${{ env.S3_BUCKET }}" \
            --set iam.roleArn="${{ env.APP_ROLE_ARN }}" \
            --wait \
            --timeout 5m \
            --atomic \
            --cleanup-on-fail
          
          echo "âœ… Helm deployment completed"

      - name: Wait for Deployment Rollout
        run: |
          echo "â³ Waiting for deployment to be ready..."
          kubectl rollout status deployment/asterra-app --timeout=120s
          
          echo "ğŸ“Š Deployment status:"
          kubectl get deployment asterra-app
          kubectl get pods -l app=asterra-app

      - name: Smoke Test
        run: |
          echo "ğŸ§ª Running smoke tests..."
          
          # Get pod name
          POD_NAME=$(kubectl get pods -l app=asterra-app -o jsonpath="{.items[0].metadata.name}")
          echo "Testing pod: $POD_NAME"
          
          # Wait a bit for the application to fully initialize
          sleep 10
          
          # Check if curl is available, otherwise use wget
          echo "ğŸ” Checking application health endpoint..."
          if kubectl exec $POD_NAME -- which curl > /dev/null 2>&1; then
            kubectl exec $POD_NAME -- curl -f -s -m 10 http://localhost:80/health
          elif kubectl exec $POD_NAME -- which wget > /dev/null 2>&1; then
            kubectl exec $POD_NAME -- wget -q -O- --timeout=10 http://localhost:80/health
          else
            echo "âš ï¸  Neither curl nor wget available in container, skipping HTTP check"
            echo "âœ… Pod is running, assuming healthy"
          fi
          
          # Check pod logs for errors
          echo "ğŸ“‹ Recent pod logs:"
          kubectl logs $POD_NAME --tail=20
          
          echo "âœ… Smoke test passed!"

      - name: Deployment Summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DEPLOYMENT SUCCESSFUL"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ·ï¸  Image: ${{ env.ECR_URL }}:${{ env.IMAGE_TAG }}"
          echo "ğŸ—„ï¸  Database: ${{ env.DB_HOST }}"
          echo "ğŸ“¦ S3 Bucket: ${{ env.S3_BUCKET }}"
          echo "ğŸ”§ Cluster: ${{ env.EKS_CLUSTER_NAME }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Show service endpoints if any
          kubectl get svc -l app=asterra-app || true

      - name: Rollback on Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed, attempting rollback..."
          helm rollback asterra-app --wait || true
          
          echo "ğŸ“‹ Failed pod logs:"
          kubectl logs -l app=asterra-app --tail=50 || true
          
          echo "ğŸ“Š Pod status:"
          kubectl get pods -l app=asterra-app || true
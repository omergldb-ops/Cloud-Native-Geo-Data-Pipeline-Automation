name: "Asterra-Full-Pipeline"

on:
  push:
    branches:
      - main
  workflow_dispatch: # מאפשר הרצה ידנית בלחיצת כפתור

permissions:
  id-token: write
  contents: read

jobs:
  terraform-and-deploy:
    runs-on: ubuntu-latest
    
    # משתני סביבה לשימוש בכל ה-Job
    env:
      TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # התחברות ל-AWS עם ה-Secrets שסידרנו
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET }}
          aws-region: us-east-1

      # התקנת Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"
          terraform_wrapper: false

      # הקמת התשתית (כולל ה-NAT Gateway וה-EKS)
      - name: Terraform Init & Apply
        run: |
          cd terraform
          terraform init
          terraform apply -auto-approve

      # שליפת הנתונים מה-Terraform לשימוש בשלבי ה-Deploy
      - name: Extract Terraform Outputs
        run: |
          cd terraform
          echo "ECR_URL=$(terraform output -raw ecr_url)" >> $GITHUB_ENV
          echo "DB_HOST=$(terraform output -raw rds_endpoint)" >> $GITHUB_ENV
          echo "S3_BUCKET=$(terraform output -raw s3_bucket)" >> $GITHUB_ENV

      # בניית האימג' ודחיפה ל-ECR
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push Image
        run: |
          docker build -t asterra-app ./app
          docker tag asterra-app:latest ${{ env.ECR_URL }}:latest
          docker push ${{ env.ECR_URL }}:latest

      - name: Update Kubeconfig
        run: |
          aws eks update-kubeconfig --name asterra-cluster --region us-east-1

      - name: Deploy to EKS
        run: |
          kubectl apply -f k8s/
          kubectl set image deployment/asterra-app asterra-app=${{ env.ECR_URL }}:latest
          kubectl set env deployment/asterra-app \
            DATABASE_URL=${{ env.DB_HOST }} \
            S3_BUCKET_NAME=${{ env.S3_BUCKET }}

      - name: Wait for Deployment & Smoke Test
        run: |
          echo "Waiting for pods to be ready..."
          kubectl rollout status deployment/asterra-app --timeout=180s
          echo "Running internal health check..."
          kubectl run smoke-test-${{ github.run_id }} --image=curlimages/curl --restart=Never --rm -i -- \
            curl -s -f --connect-timeout 5 http://asterra-app-service/health || (echo "Smoke test failed!" && exit 1)
          
          echo "Pipeline finished successfully! App is live."
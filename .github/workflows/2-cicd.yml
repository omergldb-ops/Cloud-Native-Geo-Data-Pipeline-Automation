name: 2-CI-CD

on:
  workflow_run:
    workflows: ["1-Infra-Create"]
    types: [completed]

jobs:
  build-and-deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET }}
          aws-region: us-east-1

      # שלב התקנה קריטי - שים לב שהוא שלב נפרד לחלוטין
      - name: Install Terraform CLI
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"
          terraform_wrapper: false

      # שלב בדיקה - כדי לראות אם המערכת רואה את טרפורם
      - name: Debug Path
        run: |
          which terraform || echo "Terraform NOT found in PATH"
          terraform --version || echo "Terraform command failed"

      - name: Extract Terraform Outputs
        id: tf_outputs
        run: |
          # וודא שהתיקייה terraform קיימת ברפוסיטורי שלך
          cd terraform
          terraform init -input=false
          
          # חילוץ נתונים
          ECR_URL=$(terraform output -raw ecr_url)
          DB_HOST=$(terraform output -raw rds_endpoint)
          S3_BUCKET=$(terraform output -raw s3_bucket)
          IAM_ROLE=$(terraform output -raw app_iam_role_arn)
          
          # הזרקה ל-GITHUB_ENV לשימוש בשלבים הבאים
          echo "ECR_URL=$ECR_URL" >> $GITHUB_ENV
          echo "DB_HOST=$DB_HOST" >> $GITHUB_ENV
          echo "S3_BUCKET=$S3_BUCKET" >> $GITHUB_ENV
          echo "IAM_ROLE_ARN=$IAM_ROLE" >> $GITHUB_ENV
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET }}
          AWS_REGION: us-east-1

      # המשך ה-Pipeline (ECR Login, Build, Helm...)
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build and Push Image
        run: |
          docker build -t asterra-app ./app
          docker tag asterra-app:latest ${{ env.ECR_URL }}:latest
          docker push ${{ env.ECR_URL }}:latest